
import com.amazon.deequ.{VerificationSuite, VerificationResult}
import com.amazon.deequ.VerificationResult.checkResultsAsDataFrame
import com.amazon.deequ.checks.{Check, CheckLevel}
import com.amazon.deequ.suggestions.{ConstraintSuggestionRunner, Rules}

val dataset = spark.read.option("header","true").csv("s3://visbucket-42325/geoloans/loan_data_updates.csv")

dataset.show()



/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
// // Identify Suggestions
// val suggestionResult = { ConstraintSuggestionRunner().onData(dataset).addConstraintRules(Rules.DEFAULT).run()}
// val suggestionDataFrame = suggestionResult.constraintSuggestions.flatMap { 
//   case (column, suggestions) => 
//     suggestions.map { constraint =>
//       (column, constraint.description, constraint.codeForConstraint)
//     } 
// }.toSeq.toDS()
// suggestionDataFrame.show()
/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////




val verificationResult: VerificationResult = { VerificationSuite().onData(dataset).addCheck(Check(CheckLevel.Error, "Review Check")
	.isComplete("purpose_cat")
	.isNonNegative("purpose_cat")  
	.isComplete("home_ownership")
	.isComplete("total_pymnt")
	.isComplete("interest_rate") 
	.isNonNegative("interest_rate")
	.isNonNegative("year")
	.isComplete("grade_cat") 
	.isNonNegative("grade_cat")
	.isComplete("income_cat")
	.isContainedIn("term", Array(" 36 months", " 12 months"))
	.isContainedIn("grade", Array("B", "C", "A", "D", "E", "F", "G"))
	.isContainedIn("income_category", Array("Low", "Medium", "High"))
	.isContainedIn("loan_condition", Array("Good Loan", "Bad Loan"))
	.isContainedIn("loan_condition", Array("Good Loan"), _ >= 0.92, Some("It should be above 0.92!"))                                 
).run() }

val resultDataFrame = checkResultsAsDataFrame(spark, verificationResult)

resultDataFrame.show(truncate=true)



sc.hadoopConfiguration.set("mapreduce.fileoutputcommitter.marksuccessfuljobs", "false")
sc.hadoopConfiguration.set("parquet.enable.summary-metadata", "false")
resultDataFrame.coalesce(1).write.mode("overwrite").format("com.databricks.spark.csv").option("header", "true").save("s3://visbucket-42325/results/")

sys.exit
// FileSystem hadoopFileSystem = FileSystem.get(sparkContext.hadoopConfiguration());

//     hadoopFileSystem.copyToLocalFile(true,
//         new org.apache.hadoop.fs.Path("/home/hadoop/filename.csv"),
//         new org.apache.hadoop.fs.Path("/home/hadoop/filename.csv"));


//  dataset.map(x => x.mkString("|")).saveAsTextFile("/home/hadoop/file.csv"); 

// scala> suggestionDataFrame.show(80, false)
// +--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
// |_1                  |_2                                                                                                                                                                                                                           |_3                                                                                                                                                                                                                                   |
// +--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
// |purpose_cat         |'purpose_cat' is not null                                                                                                                                                                                                    |.isComplete("purpose_cat")                                                                                                                                                                                                           |
// |purpose_cat         |'purpose_cat' has type Integral                                                                                                                                                                                              |.hasDataType("purpose_cat", ConstrainableDataTypes.Integral)                                                                                                                                                                         |
// |purpose_cat         |'purpose_cat' has no negative values                                                                                                                                                                                         |.isNonNegative("purpose_cat")                                                                                                                                                                                                        |
// |home_ownership      |'home_ownership' is not null                                                                                                                                                                                                 |.isComplete("home_ownership")                                                                                                                                                                                                        |
// |home_ownership      |'home_ownership' has value range 'MORTGAGE', 'RENT', 'OWN', 'OTHER', 'NONE', 'ANY'                                                                                                                                           |.isContainedIn("home_ownership", Array("MORTGAGE", "RENT", "OWN", "OTHER", "NONE", "ANY"))                                                                                                                                           |
// |home_ownership      |'home_ownership' has value range 'MORTGAGE', 'RENT' for at least 90.0% of values                                                                                                                                             |.isContainedIn("home_ownership", Array("MORTGAGE", "RENT"), _ >= 0.9, Some("It should be above 0.9!"))                                                                                                                               |
// |total_pymnt         |'total_pymnt' is not null                                                                                                                                                                                                    |.isComplete("total_pymnt")                                                                                                                                                                                                           |
// |total_pymnt         |'total_pymnt' has type Fractional                                                                                                                                                                                            |.hasDataType("total_pymnt", ConstrainableDataTypes.Fractional)                                                                                                                                                                       |
// |total_pymnt         |'total_pymnt' has no negative values                                                                                                                                                                                         |.isNonNegative("total_pymnt")                                                                                                                                                                                                        |
// |interest_rate       |'interest_rate' is not null                                                                                                                                                                                                  |.isComplete("interest_rate")                                                                                                                                                                                                         |
// |interest_rate       |'interest_rate' has type Fractional                                                                                                                                                                                          |.hasDataType("interest_rate", ConstrainableDataTypes.Fractional)                                                                                                                                                                     |
// |interest_rate       |'interest_rate' has no negative values                                                                                                                                                                                       |.isNonNegative("interest_rate")                                                                                                                                                                                                      |
// |term_cat            |'term_cat' is not null                                                                                                                                                                                                       |.isComplete("term_cat")                                                                                                                                                                                                              |
// |term_cat            |'term_cat' has type Integral                                                                                                                                                                                                 |.hasDataType("term_cat", ConstrainableDataTypes.Integral)                                                                                                                                                                            |
// |term_cat            |'term_cat' has no negative values                                                                                                                                                                                            |.isNonNegative("term_cat")                                                                                                                                                                                                           |
// |grade_cat           |'grade_cat' is not null                                                                                                                                                                                                      |.isComplete("grade_cat")                                                                                                                                                                                                             |
// |grade_cat           |'grade_cat' has type Integral                                                                                                                                                                                                |.hasDataType("grade_cat", ConstrainableDataTypes.Integral)                                                                                                                                                                           |
// |grade_cat           |'grade_cat' has no negative values                                                                                                                                                                                           |.isNonNegative("grade_cat")                                                                                                                                                                                                          |
// |Latitude            |'Latitude' is not null                                                                                                                                                                                                       |.isComplete("Latitude")                                                                                                                                                                                                              |
// |Latitude            |'Latitude' has type Fractional                                                                                                                                                                                               |.hasDataType("Latitude", ConstrainableDataTypes.Fractional)                                                                                                                                                                          |
// |Latitude            |'Latitude' has no negative values                                                                                                                                                                                            |.isNonNegative("Latitude")                                                                                                                                                                                                           |
// |home_ownership_cat  |'home_ownership_cat' is not null                                                                                                                                                                                             |.isComplete("home_ownership_cat")                                                                                                                                                                                                    |
// |home_ownership_cat  |'home_ownership_cat' has type Integral                                                                                                                                                                                       |.hasDataType("home_ownership_cat", ConstrainableDataTypes.Integral)                                                                                                                                                                  |
// |home_ownership_cat  |'home_ownership_cat' has no negative values                                                                                                                                                                                  |.isNonNegative("home_ownership_cat")                                                                                                                                                                                                 |
// |interest_payment_cat|'interest_payment_cat' is not null                                                                                                                                                                                           |.isComplete("interest_payment_cat")                                                                                                                                                                                                  |
// |interest_payment_cat|'interest_payment_cat' has type Integral                                                                                                                                                                                     |.hasDataType("interest_payment_cat", ConstrainableDataTypes.Integral)                                                                                                                                                                |
// |interest_payment_cat|'interest_payment_cat' has no negative values                                                                                                                                                                                |.isNonNegative("interest_payment_cat")                                                                                                                                                                                               |
// |Longitude           |'Longitude' is not null                                                                                                                                                                                                      |.isComplete("Longitude")                                                                                                                                                                                                             |
// |Longitude           |'Longitude' has type Fractional                                                                                                                                                                                              |.hasDataType("Longitude", ConstrainableDataTypes.Fractional)                                                                                                                                                                         |
// |income_cat          |'income_cat' is not null                                                                                                                                                                                                     |.isComplete("income_cat")                                                                                                                                                                                                            |
// |income_cat          |'income_cat' has type Integral                                                                                                                                                                                               |.hasDataType("income_cat", ConstrainableDataTypes.Integral)                                                                                                                                                                          |
// |income_cat          |'income_cat' has no negative values                                                                                                                                                                                          |.isNonNegative("income_cat")                                                                                                                                                                                                         |
// |recoveries          |'recoveries' is not null                                                                                                                                                                                                     |.isComplete("recoveries")                                                                                                                                                                                                            |
// |recoveries          |'recoveries' has type Fractional                                                                                                                                                                                             |.hasDataType("recoveries", ConstrainableDataTypes.Fractional)                                                                                                                                                                        |
// |recoveries          |'recoveries' has no negative values                                                                                                                                                                                          |.isNonNegative("recoveries")                                                                                                                                                                                                         |
// |final_d             |'final_d' is not null                                                                                                                                                                                                        |.isComplete("final_d")                                                                                                                                                                                                               |
// |final_d             |'final_d' has type Integral                                                                                                                                                                                                  |.hasDataType("final_d", ConstrainableDataTypes.Integral)                                                                                                                                                                             |
// |final_d             |'final_d' has no negative values                                                                                                                                                                                             |.isNonNegative("final_d")                                                                                                                                                                                                            |
// |term                |'term' is not null                                                                                                                                                                                                           |.isComplete("term")                                                                                                                                                                                                                  |
// |term                |'term' has value range ' 36 months', ' 60 months'                                                                                                                                                                            |.isContainedIn("term", Array(" 36 months", " 60 months"))                                                                                                                                                                            |
// |year                |'year' is not null                                                                                                                                                                                                           |.isComplete("year")                                                                                                                                                                                                                  |
// |year                |'year' has type Integral                                                                                                                                                                                                     |.hasDataType("year", ConstrainableDataTypes.Integral)                                                                                                                                                                                |
// |year                |'year' has no negative values                                                                                                                                                                                                |.isNonNegative("year")                                                                                                                                                                                                               |
// |loan_amount         |'loan_amount' is not null                                                                                                                                                                                                    |.isComplete("loan_amount")                                                                                                                                                                                                           |
// |loan_amount         |'loan_amount' has type Integral                                                                                                                                                                                              |.hasDataType("loan_amount", ConstrainableDataTypes.Integral)                                                                                                                                                                         |
// |loan_amount         |'loan_amount' has no negative values                                                                                                                                                                                         |.isNonNegative("loan_amount")                                                                                                                                                                                                        |
// |application_type_cat|'application_type_cat' is not null                                                                                                                                                                                           |.isComplete("application_type_cat")                                                                                                                                                                                                  |
// |application_type_cat|'application_type_cat' has type Integral                                                                                                                                                                                     |.hasDataType("application_type_cat", ConstrainableDataTypes.Integral)                                                                                                                                                                |
// |application_type_cat|'application_type_cat' has no negative values                                                                                                                                                                                |.isNonNegative("application_type_cat")                                                                                                                                                                                               |
// |emp_length_int      |'emp_length_int' is not null                                                                                                                                                                                                 |.isComplete("emp_length_int")                                                                                                                                                                                                        |
// |emp_length_int      |'emp_length_int' has type Fractional                                                                                                                                                                                         |.hasDataType("emp_length_int", ConstrainableDataTypes.Fractional)                                                                                                                                                                    |
// |emp_length_int      |'emp_length_int' has no negative values                                                                                                                                                                                      |.isNonNegative("emp_length_int")                                                                                                                                                                                                     |
// |purpose             |'purpose' is not null                                                                                                                                                                                                        |.isComplete("purpose")                                                                                                                                                                                                               |
// |purpose             |'purpose' has value range 'debt_consolidation', 'credit_card', 'home_improvement', 'other', 'major_purchase', 'small_business', 'car', 'medical', 'moving', 'vacation', 'house', 'wedding', 'renewable_energy', 'educational'|.isContainedIn("purpose", Array("debt_consolidation", "credit_card", "home_improvement", "other", "major_purchase", "small_business", "car", "medical", "moving", "vacation", "house", "wedding", "renewable_energy", "educational"))|
// |purpose             |'purpose' has value range 'debt_consolidation', 'credit_card', 'home_improvement', 'other' for at least 92.0% of values                                                                                                      |.isContainedIn("purpose", Array("debt_consolidation", "credit_card", "home_improvement", "other"), _ >= 0.92, Some("It should be above 0.92!"))                                                                                      |
// |id                  |'id' is not null                                                                                                                                                                                                             |.isComplete("id")                                                                                                                                                                                                                    |
// |id                  |'id' has type Integral                                                                                                                                                                                                       |.hasDataType("id", ConstrainableDataTypes.Integral)                                                                                                                                                                                  |
// |id                  |'id' has no negative values                                                                                                                                                                                                  |.isNonNegative("id")                                                                                                                                                                                                                 |
// |grade               |'grade' is not null                                                                                                                                                                                                          |.isComplete("grade")                                                                                                                                                                                                                 |
// |grade               |'grade' has value range 'B', 'C', 'A', 'D', 'E', 'F', 'G'                                                                                                                                                                    |.isContainedIn("grade", Array("B", "C", "A", "D", "E", "F", "G"))                                                                                                                                                                    |
// |grade               |'grade' has value range 'B', 'C', 'A', 'D', 'E' for at least 96.0% of values                                                                                                                                                 |.isContainedIn("grade", Array("B", "C", "A", "D", "E"), _ >= 0.96, Some("It should be above 0.96!"))                                                                                                                                 |
// |region              |'region' is not null                                                                                                                                                                                                         |.isComplete("region")                                                                                                                                                                                                                |
// |region              |'region' has value range 'leinster', 'ulster', 'Northern-Irl', 'cannught', 'munster'                                                                                                                                         |.isContainedIn("region", Array("leinster", "ulster", "Northern-Irl", "cannught", "munster"))                                                                                                                                         |
// |dti                 |'dti' is not null                                                                                                                                                                                                            |.isComplete("dti")                                                                                                                                                                                                                   |
// |dti                 |'dti' has type Fractional                                                                                                                                                                                                    |.hasDataType("dti", ConstrainableDataTypes.Fractional)                                                                                                                                                                               |
// |dti                 |'dti' has no negative values                                                                                                                                                                                                 |.isNonNegative("dti")                                                                                                                                                                                                                |
// |annual_inc          |'annual_inc' is not null                                                                                                                                                                                                     |.isComplete("annual_inc")                                                                                                                                                                                                            |
// |annual_inc          |'annual_inc' has type Integral                                                                                                                                                                                               |.hasDataType("annual_inc", ConstrainableDataTypes.Integral)                                                                                                                                                                          |
// |annual_inc          |'annual_inc' has no negative values                                                                                                                                                                                          |.isNonNegative("annual_inc")                                                                                                                                                                                                         |
// |interest_payments   |'interest_payments' is not null                                                                                                                                                                                              |.isComplete("interest_payments")                                                                                                                                                                                                     |
// |interest_payments   |'interest_payments' has value range 'Low', 'High'                                                                                                                                                                            |.isContainedIn("interest_payments", Array("Low", "High"))                                                                                                                                                                            |
// |installment         |'installment' is not null                                                                                                                                                                                                    |.isComplete("installment")                                                                                                                                                                                                           |
// |installment         |'installment' has type Fractional                                                                                                                                                                                            |.hasDataType("installment", ConstrainableDataTypes.Fractional)                                                                                                                                                                       |
// |installment         |'installment' has no negative values                                                                                                                                                                                         |.isNonNegative("installment")                                                                                                                                                                                                        |
// |total_rec_prncp     |'total_rec_prncp' is not null                                                                                                                                                                                                |.isComplete("total_rec_prncp")                                                                                                                                                                                                       |
// |total_rec_prncp     |'total_rec_prncp' has type Fractional                                                                                                                                                                                        |.hasDataType("total_rec_prncp", ConstrainableDataTypes.Fractional)                                                                                                                                                                   |
// |total_rec_prncp     |'total_rec_prncp' has no negative values                                                                                                                                                                                     |.isNonNegative("total_rec_prncp")                                                                                                                                                                                                    |
// |income_category     |'income_category' is not null                                                                                                                                                                                                |.isComplete("income_category")                                                                                                                                                                                                       |
// |income_category     |'income_category' has value range 'Low', 'Medium', 'High'                                                                                                                                                                    |.isContainedIn("income_category", Array("Low", "Medium", "High"))                                                                                                                                                                    |
// |income_category     |'income_category' has value range 'Low', 'Medium' for at least 98.0% of values                                                                                                                                               |.isContainedIn("income_category", Array("Low", "Medium"), _ >= 0.98, Some("It should be above 0.98!"))                                                                                                                               |
// +--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
// only showing top 80 rows
